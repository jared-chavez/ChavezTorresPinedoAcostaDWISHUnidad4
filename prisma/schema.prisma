generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String              @id @default(cuid())
  email         String              @unique
  name          String
  password      String
  role          String              @default("usuarios_regulares")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  emailVerified Boolean             @default(false)
  registeredIp  String?
  status        String              @default("pending_verification")
  verifiedAt    DateTime?
  verifiedIp    String?
  verifications EmailVerification[]
  sales         Sale[]
  vehicles      Vehicle[]

  @@index([status])
  @@index([emailVerified])
  @@map("users")
}

model Vehicle {
  id           String         @id @default(cuid())
  brand        String
  model        String
  year         Int
  color        String
  price        Float
  mileage      Int
  fuelType     String
  transmission String
  status       String         @default("available")
  vin          String         @unique
  description  String?
  images       String[]       @default([])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  createdBy    String
  sales        Sale[]
  blobImages   VehicleImage[]
  creator      User           @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([createdBy])
  @@map("vehicles")
}

model VehicleImage {
  id        String   @id @default(cuid())
  vehicleId String
  imageData Bytes
  mimeType  String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@map("vehicle_images")
}

model Sale {
  id            String   @id @default(cuid())
  vehicleId     String
  userId        String
  customerName  String
  customerEmail String
  customerPhone String
  salePrice     Float
  saleDate      DateTime @default(now())
  paymentMethod String
  notes         String?
  invoiceNumber String   @unique
  status        String   @default("completed")
  taxAmount     Float    @default(0)
  totalAmount   Float
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle       Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([userId])
  @@index([saleDate])
  @@index([invoiceNumber])
  @@index([status])
  @@map("sales")
}

model EmailVerification {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  email     String
  ipAddress String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("email_verifications")
}
